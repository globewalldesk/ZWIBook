# ZWIBook Data Standards

## Overview

This document outlines the standards for two types of JSON files used in ZWIBook: `bookshelf.json` and `hlnotes.json`. These files are used to store bookshelf data, including viewed books, saved books, reading positions, and bookmarks, as well as highlight and note data. This standard ensures data integrity and consistency across different instances of ZWIBook.

*This document was generated by ChatGPT-4 after it created the validators for inputting `bookshelf.json` and `hlnotes.json`. It has been checked a little, but not thoroughly, for accuracy.*

## Bookshelf Data (`bookshelf.json`)

### Structure

The `bookshelf.json` file can contain up to four top-level keys: `viewedBooks`, `savedBooks`, `readingPositions`, and `bookmarks`. Each of these keys corresponds to an array of objects, with specific requirements for each object type.

### Top-Level Keys

1. `viewedBooks`: Optional. Contains an array of book objects.
2. `savedBooks`: Optional. Contains an array of book objects.
3. `readingPositions`: Optional. Contains an array of reading position objects.
4. `bookmarks`: Optional. Contains an array of bookmark objects.

### Book Object

- **Title**: `<string>` (Required)
- **Topics**: `["<string>"]` (Optional, array of strings)
- **Primary**: `<string>` (Optional)
- **CreatorNames**: `["<string>"]` or `""` (Required, array of strings or empty string)
- **LoCC**: `["<string>"]` (Optional, array of strings)
- **PG_ID**: `<string>` (Required)

### Reading Position Object

- **PG_ID**: `<string>` (Required)
- **lastReadPosition**: `<string>` (Required, can be an empty string)

### Bookmark Object

- **PG_ID**: `<string>` (Required)
- **positions**: `["<string>"]` (Required, array of strings)

### Example

```json
{
  "viewedBooks": [
    {
      "Title": "Concerning Christian Liberty; with Letter of Martin Luther to Pope Leo X.",
      "Topics": ["Reformation -- Germany"],
      "Primary": "1911.htm",
      "CreatorNames": ["Luther, Martin, 1483-1546"],
      "LoCC": ["BR"],
      "PG_ID": "1911"
    }
  ],
  "savedBooks": [
    {
      "Title": "Concerning Christian Liberty; with Letter of Martin Luther to Pope Leo X.",
      "Topics": ["Reformation -- Germany"],
      "Primary": "1911.htm",
      "CreatorNames": ["Luther, Martin, 1483-1546"],
      "LoCC": ["BR"],
      "PG_ID": "1911"
    }
  ],
  "readingPositions": [
    {
      "PG_ID": "4705",
      "lastReadPosition": "0.00"
    }
  ],
  "bookmarks": [
    {
      "PG_ID": "62856",
      "positions": ["p22"]
    }
  ]
}
```

### Validation Rules

1. The root data must be an object.
2. At least one of the top-level keys (`viewedBooks`, `savedBooks`, `readingPositions`, `bookmarks`) must be present.
3. Each top-level key must contain an array of objects.
4. Each book object in `viewedBooks` and `savedBooks` must have `Title` and `PG_ID` as required fields.
5. `CreatorNames` in each book object must be an array of strings or an empty string `""`.
6. `Topics`, `Primary`, and `LoCC` are optional fields but must follow their respective formats if present.
7. Each object in `readingPositions` must have `PG_ID` and `lastReadPosition` as required fields.
8. Each object in `bookmarks` must have `PG_ID` and `positions` as required fields.

## Highlight and Note Data (`hlnotes.json`)

### Structure

The `hlnotes.json` file can contain two top-level keys: `highlights` and `notes`. Each of these keys corresponds to a nested structure of objects, with specific requirements for each level.

### Top-Level Keys

1. `highlights`: Optional. Contains an object with book IDs (PG_ID) as keys.
2. `notes`: Optional. Contains an object with book IDs (PG_ID) as keys.

### Highlight Structure

- **Book ID (PG_ID)**: Optional, but only acceptable secondary key.
  - **Paragraph ID (`<paragraph_id>`)**: Optional, but only acceptable next-level key; should be of format `/p\d+/`.
    - **cleanedHTML**: `<string>` (Required if paragraph ID exists)
    - **highlightedHTML**: `<string>` (Required if paragraph ID exists)
    - **hnids**: `[<number>]` (Required if paragraph ID exists)

### Note Structure

- **Book ID (PG_ID)**: Optional, but only acceptable secondary key.
  - **hnids**: Optional, but only acceptable tertiary key.
    - `<hnid>`: `<string>` (Not required, but only acceptable quaternary key)

### Example

```json
{
  "highlights": {
    "51511": {
      "p58": {
        "cleanedHTML": "<p class=\"\">Etymologiarum Libri XX.</p>",
        "highlightedHTML": "<p class=\"\"><span class=\"highlight-span hl-yellow\" data-hnid=\"0\">Etymologiarum Libri XX.</span></p>",
        "hnids": [
          0
        ]
      },
      "p60": {
        "cleanedHTML": "<p class=\"\">The secret of this inclusiveness lay, however, not in an expanded,\nbut in a contracted interest. Although Isidore is not surpassed in\ncomprehensiveness by any one of the line of Roman encyclopedists\nwho preceded him, in the quality of his thought and the extent of\nhis information he is inferior to them all. Secular knowledge had\nsuffered so much from attrition and decay that it could now be\nsummarized in its entirety by one man.</p>",
        "highlightedHTML": "<p class=\"\"><span class=\"highlight-span hl-green\" data-hnid=\"5\">The secret of this inclusiveness lay, however, not in an expanded,\nbut in a contracted interest.</span> Although Isidore is not surpassed in\ncomprehensiveness by any one of the line of Roman encyclopedists\nwho preceded him, in the quality of his thought and the extent of\nhis information he is inferior to them all. Secular knowledge had\nsuffered so much from attrition and decay that it could now be\nsummarized in its entirety by one man.</p>",
        "hnids": [
          5
        ]
      }
    }
  },
  "notes": {
    "51511": {
      "hnids": {
        "0": "I am the first successfully saved note, if I'm not mistaken.",
        "5": "I am a note that is *bedecked* with markdown.\n\n# I can handle much\n## But not all\n- of standard MD format\n- <a href=\"https://encyclosphere.org\">even HTML</a>\nHTML is not safety-checked at the moment...but this is a desktop app so it shouldn't matter...yet."
      }
    }
  }
}
```

### Validation Rules

1. The root data must be an object.
2. At least one of the top-level keys (`highlights`, `notes`) must be present.
3. Each secondary key under `highlights` and `notes` must be a book ID (PG_ID).
4. Each tertiary key under a book ID in `highlights` must be a paragraph ID (`<paragraph_id>`) in the format `/p\d+/`.
5. Each paragraph ID object in `highlights` must have `cleanedHTML`, `highlightedHTML`, and `hnids` as required fields.
6. Each secondary key under a book ID in `notes` must be `hnids`.
7. Each key under `hnids` in `notes` must be a highlight note ID (`<hnid>`) with a string value.

## Additional Notes

- There are two different files because the two data sets are largely independent of each other, while being more or less interdependent within the data set (especially notes and bookmarks).
- PG_ID is the Project Gutenberg book ID. ZWIBook has not changed these. You can use these to look up a book in any PG database.
- Book metadata is based on Project Gutenberg metadata.
- In `bookmarks`, the `positions` are paragraph numbers, or PIDs. The same PIDs are used for `highlights`. These are generated by ZWIBook. As long as one uses ZWIBook and the same ZWI files that Louis used when he prepared the ZWI versions of the PG books, the PIDs should be perfectly identical for different users. If you change the HTML or TXT for a file, we make no guarantees that the bookmarks, highlights, and notes (which depend on highlights) will not be messed up.
- While there can be notes without highlights (we are fairly sure this wouldn't break the code; but it might), there generally *should* be one or more highlights for each note. Notes and highlights are connected by hnids. While the ZWIBook import validator does not check this, for each `hnid` listed for a PG_ID in `notes`, there should be a `data-hnid` with the same value inside the `highlightedHTML` for one or more PID inside the `highlights` for the same PG_ID. In plain language, what this means is that all notes are attached to highlights, and there should be no notes that are not attached to highlights. We may add that ZWIBook does have a "white" color which allows the user to add a note to a section of text without a colored highlight appearing.
- The highlights a user adds to a document each have their own ID, called `hnids`, and which are initially assigned to a highlight. This `hnid` is then used to associate together spans potentially across many PIDs, and is used as the reference ID for notes.
- The highlights format might seem a bit clunky, but it is the only way we could find to make it work well. Rather than attempting to write software to

 find and re-find precise strings of text within complex HTML, we have simply assigned paragraph numbers (for ease of look-up) and the software finds and replaces some of the inner HTML with the highlighted HTML. This permits the highlighted color and the attachment of any notes.
- The `hnids` array in `highlights` (for each pid) is not strictly necessary but is included for efficient lookup; its data should be able to be extracted from `highlightedHTML`.

This standards document ensures that the JSON files used in ZWIBook are consistent and properly formatted. Following these standards will help maintain data integrity across different instances of the application.